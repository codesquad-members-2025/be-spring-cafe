<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
<!-- 네비게이션 영역 -->
<div th:replace="~{nav.html}"></div>

<div class="container mt-5">
    <!-- 게시글 상세보기 카드 -->
    <div class="card">
        <div class="card-header">
            <h2 th:text="${article.title}" class="mb-0">게시글 제목</h2>
        </div>
        <div class="card-body">
            <!-- 게시글 생성 및 수정 시간 -->
            <div class="text-muted small mb-2">
                작성일:
                <span th:text="${#temporals.format(article.createdAt, 'yyyy-MM-dd HH:mm')}">2025-04-01 13:00</span>
                <span th:if="${article.updatedAt != null and article.updatedAt != article.createdAt}">
        | 수정일: <span th:text="${#temporals.format(article.updatedAt, 'yyyy-MM-dd HH:mm')}">2025-04-01 14:00</span>
                </span>
            </div>
            <div class="mb-4">
                <pre class="card-text" style="white-space: pre-wrap;" th:text="${article.content}">게시글 내용</pre>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <a th:href="@{/articles/{id}/form(id=${article.id})}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> 수정
                </a>
                <form th:action="@{/articles/{id}(id=${article.id})}" method="post" style="display: inline;">
                    <input type="hidden" name="_method" value="DELETE"/>
                    <button type="submit" class="btn btn-danger" onclick="return confirm('정말로 삭제하시겠습니까?')">
                        <i class="bi bi-trash"></i> 삭제
                    </button>
                </form>
                <a href="/" class="btn btn-secondary">
                    <i class="bi bi-list"></i> 목록
                </a>
            </div>
        </div>
    </div>

    <!-- 댓글 목록 카드 -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>댓글</h4>
        </div>
        <div class="card-body">
            <ul class="list-group" id="replies-container">
                <!-- AJAX로 채워질 댓글 목록 -->
            </ul>
        </div>
    </div>

    <!-- 댓글 작성 폼 -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>댓글 작성</h4>
        </div>
        <div class="card-body">
            <form id="reply-form">
                <div class="mb-3">
                    <textarea id="reply-content" class="form-control" rows="3" placeholder="댓글을 입력하세요."
                              required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">댓글 등록</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</body>
<script th:inline="javascript">
    const articleId = [[${article.id}]];
    const sessionUserName = [[${session.sessionedUser != null ? session.sessionedUser.name : null}]];

    $(document).ready(function () {
        loadReplies();

        $("#reply-form").on("submit", function (e) {
            e.preventDefault();
            const content = $("#reply-content").val().trim();
            if (!content) return;

            $.ajax({
                type: "POST",
                url: `/articles/${articleId}/replies`,
                contentType: "application/json",
                data: JSON.stringify({ content }),
                success: function () {
                    $("#reply-content").val('');
                    loadReplies();
                },
                error: function () {
                    alert("댓글 등록 실패");
                }
            });
        });
    });

    function loadReplies() {
        $.ajax({
            type: "GET",
            url: `/articles/${articleId}/replies`,
            success: function (replies) {
                const container = $("#replies-container");
                if (replies.length === 0) {
                    container.html('<li class="list-group-item">댓글이 없습니다.</li>');
                    return;
                }

                const replyHtml = replies.map(reply => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${reply.writerName}</strong>
                            <div class="text-muted small mb-1">${formatDateTime(reply.createdAt)}</div>
                            <p class="mt-2 mb-0">${reply.content}</p>
                        </div>
                        ${reply.writerName === sessionUserName ? `
                        <button class="btn btn-danger btn-sm" onclick="deleteReply(${reply.id})">
                            삭제
                        </button>` : ''}
                    </li>
                `).join('');

                container.html(replyHtml);
            },
            error: function () {
                alert("댓글 불러오기 실패");
            }
        });
    }

    function deleteReply(replyId) {
        if (!confirm("정말 삭제하시겠습니까?")) return;

        $.ajax({
            type: "DELETE",
            url: `/articles/${articleId}/replies/${replyId}`,
            success: function () {
                loadReplies();
            },
            error: function () {
                alert("댓글 삭제 실패");
            }
        });
    }

    function formatDateTime(dateString) {
        const date = new Date(dateString);

        const yyyy = date.getFullYear();
        const MM = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const HH = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');

        return `${yyyy}-${MM}-${dd} ${HH}:${mm}`;
    }

</script>

</html>
