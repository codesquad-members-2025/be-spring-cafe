<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
<!-- 네비게이션 영역 -->
<div th:replace="~{nav.html}"></div>

<div class="container mt-5">
    <!-- 게시글 상세보기 카드 -->
    <div class="card">
        <div class="card-header">
            <h2 th:text="${article.title}" class="mb-0">게시글 제목</h2>
        </div>
        <div class="card-body">
            <!-- 게시글 생성 및 수정 시간 -->
            <div class="text-muted small mb-2">
                작성일:
                <span th:text="${#temporals.format(article.createdAt, 'yyyy-MM-dd HH:mm')}">2025-04-01 13:00</span>
                <span th:if="${article.updatedAt != null and article.updatedAt != article.createdAt}">
        | 수정일: <span th:text="${#temporals.format(article.updatedAt, 'yyyy-MM-dd HH:mm')}">2025-04-01 14:00</span>
                </span>
            </div>
            <div class="mb-4">
                <pre class="card-text" style="white-space: pre-wrap;" th:text="${article.content}">게시글 내용</pre>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <a th:href="@{/articles/{id}/form(id=${article.id})}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> 수정
                </a>
                <form th:action="@{/articles/{id}(id=${article.id})}" method="post" style="display: inline;">
                    <input type="hidden" name="_method" value="DELETE"/>
                    <button type="submit" class="btn btn-danger" onclick="return confirm('정말로 삭제하시겠습니까?')">
                        <i class="bi bi-trash"></i> 삭제
                    </button>
                </form>
                <a href="/" class="btn btn-secondary">
                    <i class="bi bi-list"></i> 목록
                </a>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h4>댓글</h4>
        </div>
        <div class="card-body">
            <ul class="list-group" id="replies-container"></ul>
            <div class="d-grid mt-3">
                <button id="load-more-btn" class="btn btn-outline-secondary">댓글 더보기</button>
            </div>
        </div>
    </div>

    <!-- 댓글 작성 폼 -->
    <div class="card mt-4">
        <div class="card-header"><h4>댓글 작성</h4></div>
        <div class="card-body">
            <form id="reply-form">
                <div class="mb-3">
                    <textarea id="reply-content" class="form-control" rows="3" placeholder="댓글을 입력하세요." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">댓글 등록</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script th:inline="javascript">
    const articleId = [[${article.id}]];
    const sessionUserName = [[${session.sessionedUser?.name}]];
    let currentPage = 0;
    const size = 5;
    let isLastPage = false;

    $(document).ready(function () {
        loadReplies(currentPage);

        // 댓글 등록
        $("#reply-form").on("submit", function (e) {
            e.preventDefault();
            const content = $("#reply-content").val().trim();
            if (!content) return;

            $.ajax({
                type: "POST",
                url: `/articles/${articleId}/replies`,
                contentType: "application/json",
                data: JSON.stringify({ content }),
                success: function (newReply) {
                    $("#reply-content").val('');
                    const replyHtml = renderReplyHtml(newReply);
                    const $container = $("#replies-container");

                    // 새 댓글을 맨 위에 추가
                    $container.prepend(replyHtml);

                    // 최대 5개까지만 유지
                    if ($container.children().length > size) {
                        $container.children().last().remove();
                    }
                },
                error: () => alert("댓글 등록 실패")
            });
        });

        // 댓글 더보기
        $("#load-more-btn").on("click", function () {
            if (!isLastPage) {
                loadReplies(++currentPage);
            }
        });
    });

    function loadReplies(page) {
        $.ajax({
            type: "GET",
            url: `/articles/${articleId}/replies?page=${page}&size=${size}`,
            success: function (data) {
                const replies = data.content;
                isLastPage = data.last;

                if (replies.length === 0 && page === 0) {
                    $("#replies-container").html('<li class="list-group-item">댓글이 없습니다.</li>');
                } else {
                    replies.forEach(reply => {
                        const replyHtml = renderReplyHtml(reply);
                        $("#replies-container").append(replyHtml);
                    });
                }

                if (isLastPage) {
                    $("#load-more-btn").hide();
                }
            },
            error: () => alert("댓글 불러오기 실패")
        });
    }

    function deleteReply(replyId) {
        if (!confirm("정말 삭제하시겠습니까?")) return;

        $.ajax({
            type: "DELETE",
            url: `/articles/${articleId}/replies/${replyId}`,
            success: function () {
                $(`#reply-${replyId}`).remove();
            },
            error: () => alert("댓글 삭제 실패")
        });
    }

    function renderReplyHtml(reply) {
        const time = formatDateTime(reply.createdAt);
        return `
        <li class="list-group-item d-flex justify-content-between align-items-start" id="reply-${reply.id}">
            <div>
                <strong>${reply.writerName}</strong>
                <div class="text-muted small mb-1">${time}</div>
                <p class="mb-0">${reply.content}</p>
            </div>
            ${reply.writerName === sessionUserName ? `
            <button class="btn btn-danger btn-sm ms-2" onclick="deleteReply(${reply.id})">삭제</button>` : ''}
        </li>`;
    }

    function formatDateTime(dateString) {
        const date = new Date(dateString);
        const yyyy = date.getFullYear();
        const MM = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const HH = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');
        return `${yyyy}-${MM}-${dd} ${HH}:${mm}`;
    }
</script>
</body>
</html>
